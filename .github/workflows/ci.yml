name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "20"
  PDM_VERSION: "2.20"
  PNPM_VERSION: "8"

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      whisper: ${{ steps.changes.outputs.whisper }}
      translation: ${{ steps.changes.outputs.translation }}
      orchestration: ${{ steps.changes.outputs.orchestration }}
      frontend: ${{ steps.changes.outputs.frontend }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            whisper:
              - 'modules/whisper-service/**'
            translation:
              - 'modules/translation-service/**'
            orchestration:
              - 'modules/orchestration-service/**'
            frontend:
              - 'modules/frontend-service/**'

  lint-python:
    needs: detect-changes
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - name: whisper-service
            path: modules/whisper-service
            changed: ${{ needs.detect-changes.outputs.whisper }}
          - name: translation-service
            path: modules/translation-service
            changed: ${{ needs.detect-changes.outputs.translation }}
          - name: orchestration-service
            path: modules/orchestration-service
            changed: ${{ needs.detect-changes.outputs.orchestration }}
    steps:
      - uses: actions/checkout@v6
        if: matrix.service.changed == 'true' || github.event_name == 'push'

      - name: Set up Python
        if: matrix.service.changed == 'true' || github.event_name == 'push'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install PDM
        if: matrix.service.changed == 'true' || github.event_name == 'push'
        uses: pdm-project/setup-pdm@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          version: ${{ env.PDM_VERSION }}
          cache: true
          cache-dependency-path: ${{ matrix.service.path }}/pdm.lock

      - name: Install dependencies
        if: matrix.service.changed == 'true' || github.event_name == 'push'
        working-directory: ${{ matrix.service.path }}
        run: |
          pdm install --dev --no-lock || pdm install --dev

      - name: Run ruff linting
        if: matrix.service.changed == 'true' || github.event_name == 'push'
        working-directory: ${{ matrix.service.path }}
        run: |
          pdm run ruff check src/ tests/ --output-format=github || true

      - name: Run ruff format check
        if: matrix.service.changed == 'true' || github.event_name == 'push'
        working-directory: ${{ matrix.service.path }}
        run: |
          pdm run ruff format --check src/ tests/ || true

  type-check-python:
    needs: detect-changes
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - name: whisper-service
            path: modules/whisper-service
            changed: ${{ needs.detect-changes.outputs.whisper }}
          - name: translation-service
            path: modules/translation-service
            changed: ${{ needs.detect-changes.outputs.translation }}
          - name: orchestration-service
            path: modules/orchestration-service
            changed: ${{ needs.detect-changes.outputs.orchestration }}
    steps:
      - uses: actions/checkout@v6
        if: matrix.service.changed == 'true' || github.event_name == 'push'

      - name: Set up Python
        if: matrix.service.changed == 'true' || github.event_name == 'push'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install PDM
        if: matrix.service.changed == 'true' || github.event_name == 'push'
        uses: pdm-project/setup-pdm@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          version: ${{ env.PDM_VERSION }}
          cache: true
          cache-dependency-path: ${{ matrix.service.path }}/pdm.lock

      - name: Install dependencies
        if: matrix.service.changed == 'true' || github.event_name == 'push'
        working-directory: ${{ matrix.service.path }}
        run: |
          pdm install --dev --no-lock || pdm install --dev

      - name: Run mypy type checking
        if: matrix.service.changed == 'true' || github.event_name == 'push'
        working-directory: ${{ matrix.service.path }}
        run: |
          pdm run mypy src/ --ignore-missing-imports --no-error-summary || true

  test-python:
    needs: detect-changes
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - name: whisper-service
            path: modules/whisper-service
            changed: ${{ needs.detect-changes.outputs.whisper }}
          - name: translation-service
            path: modules/translation-service
            changed: ${{ needs.detect-changes.outputs.translation }}
          - name: orchestration-service
            path: modules/orchestration-service
            changed: ${{ needs.detect-changes.outputs.orchestration }}
    steps:
      - uses: actions/checkout@v6
        if: matrix.service.changed == 'true' || github.event_name == 'push'

      - name: Set up Python
        if: matrix.service.changed == 'true' || github.event_name == 'push'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install PDM
        if: matrix.service.changed == 'true' || github.event_name == 'push'
        uses: pdm-project/setup-pdm@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          version: ${{ env.PDM_VERSION }}
          cache: true
          cache-dependency-path: ${{ matrix.service.path }}/pdm.lock

      - name: Install system dependencies
        if: matrix.service.changed == 'true' || github.event_name == 'push'
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libsndfile1 portaudio19-dev

      - name: Install dependencies
        if: matrix.service.changed == 'true' || github.event_name == 'push'
        working-directory: ${{ matrix.service.path }}
        run: |
          pdm install --dev --no-lock || pdm install --dev

      - name: Run pytest with coverage
        if: matrix.service.changed == 'true' || github.event_name == 'push'
        working-directory: ${{ matrix.service.path }}
        run: |
          pdm run pytest tests/ \
            --cov=src \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            -v \
            --tb=short \
            -m "not slow and not gpu and not integration" \
            || true

      - name: Upload coverage report
        if: (matrix.service.changed == 'true' || github.event_name == 'push') && always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.service.name }}
          path: ${{ matrix.service.path }}/coverage.xml
          retention-days: 7

      - name: Upload coverage to Codecov
        if: (matrix.service.changed == 'true' || github.event_name == 'push') && always()
        uses: codecov/codecov-action@v5
        with:
          file: ${{ matrix.service.path }}/coverage.xml
          flags: ${{ matrix.service.name }}
          name: ${{ matrix.service.name }}
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  lint-frontend:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: modules/frontend-service
    steps:
      - uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: modules/frontend-service/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm lint || true

      - name: Run Prettier check
        run: pnpm format:check || true

  type-check-frontend:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: modules/frontend-service
    steps:
      - uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: modules/frontend-service/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript type check
        run: pnpm type-check

  test-frontend:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: modules/frontend-service
    steps:
      - uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: modules/frontend-service/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Vitest
        run: pnpm test:coverage || true

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-frontend
          path: modules/frontend-service/coverage/
          retention-days: 7

  build-frontend:
    needs: [lint-frontend, type-check-frontend, test-frontend]
    if: needs.detect-changes.outputs.frontend == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: modules/frontend-service
    steps:
      - uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: modules/frontend-service/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build production bundle
        run: pnpm build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: modules/frontend-service/dist/
          retention-days: 7

  ci-status:
    needs:
      - lint-python
      - type-check-python
      - test-python
      - lint-frontend
      - type-check-frontend
      - test-frontend
      - build-frontend
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check CI Status
        run: |
          if [[ "${{ needs.lint-python.result }}" == "failure" ]] || \
             [[ "${{ needs.type-check-python.result }}" == "failure" ]] || \
             [[ "${{ needs.test-python.result }}" == "failure" ]] || \
             [[ "${{ needs.lint-frontend.result }}" == "failure" ]] || \
             [[ "${{ needs.type-check-frontend.result }}" == "failure" ]] || \
             [[ "${{ needs.test-frontend.result }}" == "failure" ]] || \
             [[ "${{ needs.build-frontend.result }}" == "failure" ]]; then
            echo "CI failed"
            exit 1
          fi
          echo "CI passed successfully"
