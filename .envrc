# ==============================================================================
# LiveTranslate direnv Configuration
# ==============================================================================
#
# This file configures direnv for automatic environment setup.
# Install direnv: https://direnv.net/
#
# After installing direnv, run:
#   direnv allow
#
# ==============================================================================

# Fail fast on errors
set -e

# ==============================================================================
# PDM Virtual Environment
# ==============================================================================

# Check if we're in a service directory with PDM
if [[ -f "pyproject.toml" ]] && command -v pdm &> /dev/null; then
    # Use PDM layout
    layout_pdm() {
        VIRTUAL_ENV=$(pdm venv list 2>/dev/null | grep 'in-project' | awk '{print $NF}')
        if [[ -z "$VIRTUAL_ENV" ]]; then
            VIRTUAL_ENV=$(pdm info --where 2>/dev/null)/.venv
        fi
        if [[ -d "$VIRTUAL_ENV" ]]; then
            export VIRTUAL_ENV
            PATH_add "$VIRTUAL_ENV/bin"
        fi
    }
    layout pdm
fi

# ==============================================================================
# Poetry Virtual Environment (Fallback)
# ==============================================================================

# If PDM not available, try Poetry
if [[ -f "pyproject.toml" ]] && ! command -v pdm &> /dev/null && command -v poetry &> /dev/null; then
    layout_poetry() {
        VIRTUAL_ENV=$(poetry env info --path 2>/dev/null)
        if [[ -d "$VIRTUAL_ENV" ]]; then
            export VIRTUAL_ENV
            PATH_add "$VIRTUAL_ENV/bin"
        fi
    }
    layout poetry
fi

# ==============================================================================
# Common Environment Variables
# ==============================================================================

# Project paths
export PROJECT_ROOT="${PWD}"
export MODULES_DIR="${PROJECT_ROOT}/modules"

# Service ports
export FRONTEND_PORT=5173
export ORCHESTRATION_PORT=3000
export WHISPER_PORT=5001
export TRANSLATION_PORT=5003
export MONITORING_PORT=3001
export PROMETHEUS_PORT=9090

# Database configuration
export POSTGRES_HOST=localhost
export POSTGRES_PORT=5432
export POSTGRES_DB=livetranslate
export POSTGRES_USER=livetranslate

# Redis configuration
export REDIS_HOST=localhost
export REDIS_PORT=6379

# Logging configuration
export LOG_LEVEL=${LOG_LEVEL:-INFO}
export PYTHONUNBUFFERED=1

# Development mode
export NODE_ENV=development
export FLASK_ENV=development
export FASTAPI_ENV=development

# ==============================================================================
# Service-Specific Configuration
# ==============================================================================

# Orchestration service
export ORCHESTRATION_SERVICE_URL="http://localhost:${ORCHESTRATION_PORT}"

# Whisper service
export WHISPER_SERVICE_URL="http://localhost:${WHISPER_PORT}"

# Translation service
export TRANSLATION_SERVICE_URL="http://localhost:${TRANSLATION_PORT}"

# Frontend service
export VITE_API_BASE_URL="http://localhost:${ORCHESTRATION_PORT}"
export VITE_WS_BASE_URL="ws://localhost:${ORCHESTRATION_PORT}"

# ==============================================================================
# Python Path
# ==============================================================================

# Add common paths to PYTHONPATH
if [[ -d "${PROJECT_ROOT}/modules/orchestration-service/src" ]]; then
    path_add PYTHONPATH "${PROJECT_ROOT}/modules/orchestration-service"
fi

if [[ -d "${PROJECT_ROOT}/modules/whisper-service/src" ]]; then
    path_add PYTHONPATH "${PROJECT_ROOT}/modules/whisper-service"
fi

if [[ -d "${PROJECT_ROOT}/modules/translation-service/src" ]]; then
    path_add PYTHONPATH "${PROJECT_ROOT}/modules/translation-service"
fi

# ==============================================================================
# Node.js Configuration
# ==============================================================================

# Use local node_modules binaries
if [[ -d "node_modules/.bin" ]]; then
    PATH_add node_modules/.bin
fi

# ==============================================================================
# Load Local Overrides
# ==============================================================================

# Load .env.local if it exists (for local overrides)
if [[ -f ".env.local" ]]; then
    dotenv .env.local
fi

# Load service-specific .env if in a service directory
if [[ -f ".env" ]]; then
    dotenv .env
fi

# ==============================================================================
# Status Message
# ==============================================================================

echo "LiveTranslate development environment loaded"
echo "  Project root: ${PROJECT_ROOT}"
echo "  Log level: ${LOG_LEVEL}"
