# ==============================================================================
# Whisper Service Configuration
# ==============================================================================
# Copy this file to .env and adjust values as needed
#
# This service provides:
# - NPU-optimized Whisper transcription (Intel NPU primary)
# - GPU/CPU fallback support
# - Speaker diarization
# - Voice Activity Detection (VAD)
# - Language identification (LID)
#

# ==============================================================================
# Server Configuration
# ==============================================================================

# Service port
PORT=5001

# Host binding (0.0.0.0 for all interfaces)
HOST=0.0.0.0

# ==============================================================================
# Device Configuration (Hardware Acceleration)
# ==============================================================================

# Primary device: npu, gpu, cpu, auto
# - npu: Intel NPU via OpenVINO (recommended for Intel systems)
# - gpu: NVIDIA GPU via CUDA
# - cpu: CPU fallback
# - auto: Automatically detect best available device
DEVICE=auto

# Fallback device chain (comma-separated)
# DEVICE_FALLBACK=gpu,cpu

# OpenVINO device for NPU acceleration
# Options: NPU, GPU, CPU
OPENVINO_DEVICE=NPU

# CUDA device ID (for multi-GPU systems)
# CUDA_VISIBLE_DEVICES=0

# ==============================================================================
# Model Configuration
# ==============================================================================

# Whisper model size: tiny, base, small, medium, large, large-v2, large-v3
WHISPER_MODEL=whisper-base

# Model precision: fp32, fp16, int8
# - fp16: Good balance of speed and accuracy (recommended for GPU)
# - int8: Fastest, slight accuracy loss (recommended for NPU/CPU)
# MODEL_PRECISION=fp16

# ==============================================================================
# Logging Configuration
# ==============================================================================

# Log level: DEBUG, INFO, WARNING, ERROR, CRITICAL
LOG_LEVEL=INFO

# Enable performance logging (timing metrics)
ENABLE_PERF_LOGGING=true

# Enable detailed audio statistics logging (for debugging)
ENABLE_DEBUG_AUDIO=false


# ============================================================================
# Whisper Configuration
# ============================================================================

# Whisper model path (required)
# WHISPER_MODEL_PATH=/path/to/whisper-large-v3-turbo.pt

# Whisper models directory (optional, defaults to ~/.whisper/models)
# WHISPER_MODELS_DIR=/path/to/models

# Decoder type: "greedy" or "beam"
WHISPER_DECODER_TYPE=greedy

# Beam size (only used if decoder_type="beam")
WHISPER_BEAM_SIZE=1

# Online chunk size in seconds
WHISPER_CHUNK_SIZE=1.2

# Audio sampling rate (8000 or 16000)
WHISPER_SAMPLING_RATE=16000

# Target languages (comma-separated)
WHISPER_LANGUAGES=en,zh

# Minimum audio length in seconds
WHISPER_AUDIO_MIN_LEN=1.0

# Number of mel spectrogram bands (128 for large-v3, 80 for older models)
WHISPER_N_MELS=80


# ============================================================================
# VAD Configuration
# ============================================================================

# VAD speech probability threshold (0.0-1.0)
# Higher = more aggressive silence filtering
VAD_THRESHOLD=0.5

# VAD sampling rate (8000 or 16000)
VAD_SAMPLING_RATE=16000

# Minimum silence duration in ms before ending speech
# Default: 500ms (SimulStreaming baseline)
VAD_MIN_SILENCE_MS=500

# Speech padding in ms (added around speech segments)
VAD_SPEECH_PAD_MS=100

# Silence detection threshold (chunks without output before declaring silence)
# Default: 10 chunks (~5s at 0.5s/chunk)
VAD_SILENCE_THRESHOLD_CHUNKS=10


# ============================================================================
# Language ID (LID) Configuration
# ============================================================================

# LID frame hop in ms (frame rate = 1000/hop_ms)
# Default: 100ms = 10Hz frame rate
LID_HOP_MS=100

# Enable median smoothing
LID_SMOOTHING_ENABLED=true

# Smoothing window size (frames)
LID_SMOOTHING_WINDOW=5

# Confidence margin for language switches (P(new) - P(old) threshold)
# Per FEEDBACK.md: 0.2 recommended
# Range: 0.1-0.5
LID_CONFIDENCE_MARGIN=0.2

# Minimum consecutive frames for sustained detection
# Per FEEDBACK.md: 6 frames recommended
LID_MIN_DWELL_FRAMES=6

# Minimum dwell time in ms
# Per FEEDBACK.md: 250ms recommended
LID_MIN_DWELL_MS=250.0

# Viterbi smoother transition cost (prefer staying in same language)
LID_VITERBI_TRANSITION_COST=0.3

# Viterbi smoother window size (frames)
LID_VITERBI_WINDOW=5


# ============================================================================
# Performance Tuning
# ============================================================================

# Number of threads for audio processing (optional)
# OMP_NUM_THREADS=4

# Torch threads (optional)
# TORCH_NUM_THREADS=4


# ============================================================================
# Development Settings
# ============================================================================

# Enable debug mode (more verbose logging)
# DEBUG=false

# Enable profiling
# ENABLE_PROFILING=false

# Profile output directory
# PROFILE_OUTPUT_DIR=./profiles


# ==============================================================================
# Speaker Diarization Configuration
# ==============================================================================

# Enable speaker diarization
DIARIZATION_ENABLED=true

# Diarization model (pyannote.audio)
# DIARIZATION_MODEL=pyannote/speaker-diarization-3.1

# Maximum number of speakers (0 = auto-detect)
MAX_SPEAKERS=0

# Minimum speech duration for speaker detection (seconds)
MIN_SPEECH_DURATION=0.5


# ==============================================================================
# Service Integration
# ==============================================================================

# Orchestration service URL (for service discovery)
ORCHESTRATION_URL=http://localhost:3000

# Enable service registration with orchestration
REGISTER_WITH_ORCHESTRATION=true

# Health check interval (seconds)
HEALTH_CHECK_INTERVAL=30

# Redis URL for caching (optional)
# REDIS_URL=redis://localhost:6379/0

# ==============================================================================
# API Settings
# ==============================================================================

# Maximum audio file size (bytes)
MAX_AUDIO_SIZE=52428800

# Supported audio formats
SUPPORTED_FORMATS=wav,mp3,webm,ogg,flac,m4a

# Request timeout (seconds)
REQUEST_TIMEOUT=300

# Maximum concurrent transcription requests
MAX_CONCURRENT_REQUESTS=10
