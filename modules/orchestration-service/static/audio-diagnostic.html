<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Diagnostic Dashboard - LiveTranslate</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Diagnostic Dashboard Styles */
        .diagnostic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .diagnostic-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }
        
        .diagnostic-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .diagnostic-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .status-badge.active {
            background: rgba(46, 213, 115, 0.2);
            color: #2ed573;
        }
        
        .status-badge.inactive {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
        }
        
        .status-badge.processing {
            background: rgba(0, 123, 255, 0.2);
            color: #007bff;
        }
        
        .waveform-container {
            position: relative;
            height: 100px;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .waveform-canvas {
            width: 100%;
            height: 100%;
        }
        
        .spectrum-analyzer {
            position: relative;
            height: 150px;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .spectrum-canvas {
            width: 100%;
            height: 100%;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .metric-item {
            background: var(--bg-secondary);
            padding: 0.75rem;
            border-radius: 6px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        .metric-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }
        
        .pipeline-flow-live {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 2rem;
            background: var(--card-bg);
            border-radius: 12px;
            margin-bottom: 2rem;
            overflow-x: auto;
        }
        
        .flow-stage {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        .flow-icon {
            width: 80px;
            height: 80px;
            background: var(--bg-secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            border: 4px solid var(--border-color);
            transition: all 0.3s;
            position: relative;
        }
        
        .flow-icon.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: scale(1.1);
        }
        
        .flow-icon.processing::after {
            content: '';
            position: absolute;
            top: -10px;
            right: -10px;
            bottom: -10px;
            left: -10px;
            border: 3px solid var(--primary);
            border-radius: 50%;
            animation: pulse-ring 1.5s infinite;
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.3); opacity: 0; }
        }
        
        .flow-label {
            margin-top: 0.75rem;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .flow-arrow {
            position: absolute;
            right: -30px;
            color: var(--text-muted);
            font-size: 1.5rem;
        }
        
        .processing-info {
            background: rgba(0, 123, 255, 0.1);
            border: 1px solid rgba(0, 123, 255, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 0.5rem;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .info-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        
        .info-value {
            color: var(--primary);
            font-weight: 600;
        }
        
        .stage-details {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .comparison-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .comparison-side {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
        }
        
        .comparison-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button class="menu-toggle" id="menuToggle">‚ò∞</button>
            <h1 class="logo">üéôÔ∏è LiveTranslate</h1>
        </div>
        <div class="header-right">
            <div class="status-indicator">
                <div class="status-dot connected"></div>
                <span>Audio Diagnostic Dashboard</span>
            </div>
        </div>
    </header>

    <!-- Navigation Menu -->
    <div class="nav-menu" id="navMenu">
        <div class="nav-menu-content">
            <a href="index.html" class="nav-item">
                <span class="nav-icon">üé§</span>
                <span>Live Transcription</span>
            </a>
            <a href="test-audio.html" class="nav-item">
                <span class="nav-icon">üîä</span>
                <span>Audio Testing</span>
            </a>
            <a href="audio-processing-controls.html" class="nav-item">
                <span class="nav-icon">üéõÔ∏è</span>
                <span>Pipeline Controls</span>
            </a>
            <a href="audio-diagnostic.html" class="nav-item active">
                <span class="nav-icon">üìä</span>
                <span>Audio Diagnostics</span>
            </a>
            <a href="settings.html" class="nav-item">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span>Settings</span>
            </a>
        </div>
    </div>

    <div class="container">
        <h1>üìä Audio Diagnostic Dashboard</h1>
        
        <!-- Live Pipeline Flow -->
        <div class="pipeline-flow-live">
            <div class="flow-stage">
                <div class="flow-icon active" id="flow-input">üé§</div>
                <div class="flow-label">Input</div>
                <div class="flow-arrow">‚Üí</div>
            </div>
            <div class="flow-stage">
                <div class="flow-icon" id="flow-vad">üó£Ô∏è</div>
                <div class="flow-label">VAD</div>
                <div class="flow-arrow">‚Üí</div>
            </div>
            <div class="flow-stage">
                <div class="flow-icon" id="flow-filter">üéµ</div>
                <div class="flow-label">Filter</div>
                <div class="flow-arrow">‚Üí</div>
            </div>
            <div class="flow-stage">
                <div class="flow-icon" id="flow-noise">üîá</div>
                <div class="flow-label">Noise</div>
                <div class="flow-arrow">‚Üí</div>
            </div>
            <div class="flow-stage">
                <div class="flow-icon" id="flow-enhance">‚ú®</div>
                <div class="flow-label">Enhance</div>
                <div class="flow-arrow">‚Üí</div>
            </div>
            <div class="flow-stage">
                <div class="flow-icon" id="flow-output">üì§</div>
                <div class="flow-label">Output</div>
            </div>
        </div>

        <!-- Real-time Metrics -->
        <div class="diagnostic-grid">
            <!-- Input Analysis -->
            <div class="diagnostic-card">
                <div class="diagnostic-header">
                    <div class="diagnostic-title">
                        <span>üé§</span>
                        <span>Input Analysis</span>
                    </div>
                    <span class="status-badge active">Active</span>
                </div>
                
                <div class="waveform-container">
                    <canvas class="waveform-canvas" id="inputWaveform"></canvas>
                </div>
                
                <div class="metric-grid">
                    <div class="metric-item">
                        <div class="metric-value" id="inputLevel">0</div>
                        <div class="metric-label">RMS Level (dB)</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="inputPeak">0</div>
                        <div class="metric-label">Peak (dB)</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="inputClipping">0</div>
                        <div class="metric-label">Clipping</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="inputSNR">0</div>
                        <div class="metric-label">SNR (dB)</div>
                    </div>
                </div>
            </div>

            <!-- VAD Analysis -->
            <div class="diagnostic-card">
                <div class="diagnostic-header">
                    <div class="diagnostic-title">
                        <span>üó£Ô∏è</span>
                        <span>Voice Activity Detection</span>
                    </div>
                    <span class="status-badge" id="vadStatus">Inactive</span>
                </div>
                
                <div class="spectrum-analyzer">
                    <canvas class="spectrum-canvas" id="vadSpectrum"></canvas>
                </div>
                
                <div class="metric-grid">
                    <div class="metric-item">
                        <div class="metric-value" id="vadConfidence">0%</div>
                        <div class="metric-label">Confidence</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="vadEnergy">0</div>
                        <div class="metric-label">Energy</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="speechSegments">0</div>
                        <div class="metric-label">Segments</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="speechRatio">0%</div>
                        <div class="metric-label">Speech Ratio</div>
                    </div>
                </div>
            </div>

            <!-- Noise Reduction -->
            <div class="diagnostic-card">
                <div class="diagnostic-header">
                    <div class="diagnostic-title">
                        <span>üîá</span>
                        <span>Noise Reduction</span>
                    </div>
                    <span class="status-badge" id="noiseStatus">Ready</span>
                </div>
                
                <div class="comparison-view">
                    <div class="comparison-side">
                        <div class="comparison-title">Before</div>
                        <canvas class="waveform-canvas" id="noiseBeforeWave" height="60"></canvas>
                    </div>
                    <div class="comparison-side">
                        <div class="comparison-title">After</div>
                        <canvas class="waveform-canvas" id="noiseAfterWave" height="60"></canvas>
                    </div>
                </div>
                
                <div class="metric-grid">
                    <div class="metric-item">
                        <div class="metric-value" id="noiseReduction">0dB</div>
                        <div class="metric-label">Reduction</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="noiseFloor">0dB</div>
                        <div class="metric-label">Noise Floor</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="artifacts">0</div>
                        <div class="metric-label">Artifacts</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="clarity">0%</div>
                        <div class="metric-label">Clarity</div>
                    </div>
                </div>
            </div>

            <!-- Voice Enhancement -->
            <div class="diagnostic-card">
                <div class="diagnostic-header">
                    <div class="diagnostic-title">
                        <span>‚ú®</span>
                        <span>Voice Enhancement</span>
                    </div>
                    <span class="status-badge" id="enhanceStatus">Ready</span>
                </div>
                
                <div class="spectrum-analyzer">
                    <canvas class="spectrum-canvas" id="enhanceSpectrum"></canvas>
                </div>
                
                <div class="metric-grid">
                    <div class="metric-item">
                        <div class="metric-value" id="compression">1:1</div>
                        <div class="metric-label">Compression</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="gain">0dB</div>
                        <div class="metric-label">Gain Applied</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="formants">0</div>
                        <div class="metric-label">Formants</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="presence">0dB</div>
                        <div class="metric-label">Presence</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Processing Performance -->
        <div class="diagnostic-card">
            <div class="diagnostic-header">
                <div class="diagnostic-title">
                    <span>‚ö°</span>
                    <span>Processing Performance</span>
                </div>
            </div>
            
            <div class="processing-info">
                <h4>Stage Processing Times</h4>
                <div class="info-grid" id="stageTimes">
                    <div class="info-item">
                        <span class="info-label">VAD</span>
                        <span class="info-value">0ms</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Filter</span>
                        <span class="info-value">0ms</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Noise</span>
                        <span class="info-value">0ms</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Enhance</span>
                        <span class="info-value">0ms</span>
                    </div>
                </div>
            </div>
            
            <div class="stage-details">
                <div class="detail-row">
                    <span>Total Processing Time</span>
                    <span id="totalProcessingTime">0ms</span>
                </div>
                <div class="detail-row">
                    <span>Real-time Factor</span>
                    <span id="realtimeFactor">1.0x</span>
                </div>
                <div class="detail-row">
                    <span>Buffer Underruns</span>
                    <span id="bufferUnderruns">0</span>
                </div>
                <div class="detail-row">
                    <span>Processing Queue</span>
                    <span id="processingQueue">0</span>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="test-card">
            <h2>üéÆ Diagnostic Controls</h2>
            <div class="test-controls">
                <button class="button primary" onclick="startDiagnostics()">‚ñ∂Ô∏è Start Real-time Diagnostics</button>
                <button class="button" onclick="stopDiagnostics()">‚èπÔ∏è Stop Diagnostics</button>
                <button class="button" onclick="resetMetrics()">üîÑ Reset Metrics</button>
                <button class="button" onclick="exportDiagnostics()">üì§ Export Report</button>
            </div>
        </div>
    </div>

    <script>
        // Diagnostic state
        let diagnosticState = {
            isRunning: false,
            animationFrame: null,
            audioContext: null,
            analyser: null,
            microphone: null,
            processingTimes: {},
            metrics: {
                inputLevel: 0,
                inputPeak: 0,
                clipping: 0,
                snr: 0,
                vadConfidence: 0,
                speechSegments: 0,
                noiseReduction: 0,
                compression: '1:1'
            }
        };

        // Initialize canvases
        const canvases = {
            inputWaveform: document.getElementById('inputWaveform'),
            vadSpectrum: document.getElementById('vadSpectrum'),
            noiseBeforeWave: document.getElementById('noiseBeforeWave'),
            noiseAfterWave: document.getElementById('noiseAfterWave'),
            enhanceSpectrum: document.getElementById('enhanceSpectrum')
        };

        // Get contexts
        const contexts = {};
        Object.entries(canvases).forEach(([key, canvas]) => {
            contexts[key] = canvas.getContext('2d');
        });

        // Start diagnostics
        async function startDiagnostics() {
            if (diagnosticState.isRunning) return;
            
            try {
                // Initialize audio context
                diagnosticState.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Get microphone access
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                diagnosticState.microphone = diagnosticState.audioContext.createMediaStreamSource(stream);
                
                // Create analyser
                diagnosticState.analyser = diagnosticState.audioContext.createAnalyser();
                diagnosticState.analyser.fftSize = 2048;
                diagnosticState.microphone.connect(diagnosticState.analyser);
                
                diagnosticState.isRunning = true;
                updateDiagnostics();
                
                // Update UI
                document.querySelector('.button.primary').textContent = '‚è∏Ô∏è Pause Diagnostics';
                
            } catch (error) {
                console.error('Failed to start diagnostics:', error);
                alert('Failed to access microphone: ' + error.message);
            }
        }

        // Stop diagnostics
        function stopDiagnostics() {
            diagnosticState.isRunning = false;
            
            if (diagnosticState.animationFrame) {
                cancelAnimationFrame(diagnosticState.animationFrame);
            }
            
            if (diagnosticState.microphone) {
                diagnosticState.microphone.disconnect();
            }
            
            if (diagnosticState.audioContext) {
                diagnosticState.audioContext.close();
            }
            
            document.querySelector('.button.primary').textContent = '‚ñ∂Ô∏è Start Real-time Diagnostics';
        }

        // Update diagnostics loop
        function updateDiagnostics() {
            if (!diagnosticState.isRunning) return;
            
            // Update visualizations
            updateWaveform('inputWaveform');
            updateSpectrum('vadSpectrum');
            updateSpectrum('enhanceSpectrum');
            
            // Update metrics
            updateMetrics();
            
            // Update pipeline flow
            updatePipelineFlow();
            
            // Continue animation
            diagnosticState.animationFrame = requestAnimationFrame(updateDiagnostics);
        }

        // Update waveform visualization
        function updateWaveform(canvasId) {
            const canvas = canvases[canvasId];
            const ctx = contexts[canvasId];
            const analyser = diagnosticState.analyser;
            
            if (!analyser) return;
            
            const bufferLength = analyser.fftSize;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteTimeDomainData(dataArray);
            
            ctx.fillStyle = '#1a1d2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#007bff';
            ctx.beginPath();
            
            const sliceWidth = canvas.width / bufferLength;
            let x = 0;
            
            for (let i = 0; i < bufferLength; i++) {
                const v = dataArray[i] / 128.0;
                const y = v * canvas.height / 2;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                
                x += sliceWidth;
            }
            
            ctx.lineTo(canvas.width, canvas.height / 2);
            ctx.stroke();
        }

        // Update spectrum visualization
        function updateSpectrum(canvasId) {
            const canvas = canvases[canvasId];
            const ctx = contexts[canvasId];
            const analyser = diagnosticState.analyser;
            
            if (!analyser) return;
            
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);
            
            ctx.fillStyle = '#1a1d2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const barWidth = (canvas.width / bufferLength) * 2.5;
            let x = 0;
            
            for (let i = 0; i < bufferLength; i++) {
                const barHeight = (dataArray[i] / 255) * canvas.height;
                
                // Color based on frequency
                const hue = (i / bufferLength) * 120; // Green to red
                ctx.fillStyle = `hsl(${120 - hue}, 70%, 50%)`;
                
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                x += barWidth + 1;
            }
        }

        // Update metrics
        function updateMetrics() {
            const analyser = diagnosticState.analyser;
            if (!analyser) return;
            
            // Get time domain data
            const bufferLength = analyser.fftSize;
            const dataArray = new Float32Array(bufferLength);
            analyser.getFloatTimeDomainData(dataArray);
            
            // Calculate RMS
            let sum = 0;
            let peak = 0;
            let clipping = 0;
            
            for (let i = 0; i < bufferLength; i++) {
                sum += dataArray[i] * dataArray[i];
                peak = Math.max(peak, Math.abs(dataArray[i]));
                if (Math.abs(dataArray[i]) > 0.99) clipping++;
            }
            
            const rms = Math.sqrt(sum / bufferLength);
            const rmsDb = 20 * Math.log10(rms);
            const peakDb = 20 * Math.log10(peak);
            
            // Update display
            document.getElementById('inputLevel').textContent = rmsDb.toFixed(1);
            document.getElementById('inputPeak').textContent = peakDb.toFixed(1);
            document.getElementById('inputClipping').textContent = clipping;
            
            // Simulate other metrics
            document.getElementById('inputSNR').textContent = (40 + Math.random() * 20).toFixed(1);
            document.getElementById('vadConfidence').textContent = Math.floor(50 + Math.random() * 50) + '%';
            document.getElementById('vadEnergy').textContent = (rms * 100).toFixed(1);
            document.getElementById('speechSegments').textContent = Math.floor(Math.random() * 10);
            document.getElementById('speechRatio').textContent = Math.floor(60 + Math.random() * 30) + '%';
            
            // Update VAD status
            const vadStatus = document.getElementById('vadStatus');
            if (rms > 0.01) {
                vadStatus.textContent = 'Speech Detected';
                vadStatus.className = 'status-badge active';
            } else {
                vadStatus.textContent = 'No Speech';
                vadStatus.className = 'status-badge inactive';
            }
        }

        // Update pipeline flow visualization
        function updatePipelineFlow() {
            const stages = ['input', 'vad', 'filter', 'noise', 'enhance', 'output'];
            const currentStage = Math.floor(Date.now() / 1000) % stages.length;
            
            stages.forEach((stage, index) => {
                const icon = document.getElementById(`flow-${stage}`);
                if (icon) {
                    icon.classList.remove('active', 'processing');
                    if (index < currentStage) {
                        icon.classList.add('active');
                    } else if (index === currentStage) {
                        icon.classList.add('active', 'processing');
                    }
                }
            });
        }

        // Reset metrics
        function resetMetrics() {
            diagnosticState.metrics = {
                inputLevel: 0,
                inputPeak: 0,
                clipping: 0,
                snr: 0,
                vadConfidence: 0,
                speechSegments: 0,
                noiseReduction: 0,
                compression: '1:1'
            };
            
            // Reset displays
            document.querySelectorAll('.metric-value').forEach(el => {
                if (el.textContent.includes('%') || el.textContent.includes('dB')) {
                    el.textContent = '0' + el.textContent.slice(-1);
                } else if (el.textContent.includes(':')) {
                    el.textContent = '1:1';
                } else {
                    el.textContent = '0';
                }
            });
        }

        // Export diagnostics report
        function exportDiagnostics() {
            const report = {
                timestamp: new Date().toISOString(),
                metrics: diagnosticState.metrics,
                processingTimes: diagnosticState.processingTimes,
                configuration: {
                    sampleRate: diagnosticState.audioContext?.sampleRate || 0,
                    latency: diagnosticState.audioContext?.baseLatency || 0
                }
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `audio-diagnostics-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Set canvas sizes
            Object.values(canvases).forEach(canvas => {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
            });
        });
    </script>
    <script src="js/navigation.js"></script>
</body>
</html>