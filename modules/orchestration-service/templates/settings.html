<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - LiveTranslate</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        .settings-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .settings-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }
        
        .settings-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .setting-item {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .setting-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        
        .setting-description {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }
        
        .setting-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        
        .setting-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        
        .setting-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .setting-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        .settings-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }
        
        .service-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .service-status.healthy {
            background: rgba(46, 213, 115, 0.2);
            color: #2ed573;
        }
        
        .service-status.unhealthy {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
        }
        
        .service-status.unknown {
            background: rgba(255, 193, 7, 0.2);
            color: #ffa502;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button class="menu-toggle" id="menuToggle">‚ò∞</button>
            <h1 class="logo">üéôÔ∏è LiveTranslate</h1>
        </div>
        <div class="header-right">
            <div class="status-indicator">
                <div class="status-dot connected"></div>
                <span>Settings</span>
            </div>
        </div>
    </header>

    <!-- Navigation Menu -->
    <div class="nav-menu" id="navMenu">
        <div class="nav-menu-content">
            <a href="{{ url_for('dashboard') }}" class="nav-item">
                <span class="nav-icon">üé§</span>
                <span>Live Transcription</span>
            </a>
            <a href="{{ url_for('audio_test') }}" class="nav-item">
                <span class="nav-icon">üîä</span>
                <span>Audio Testing</span>
            </a>
            <a href="{{ url_for('websocket_test') }}" class="nav-item">
                <span class="nav-icon">üîå</span>
                <span>WebSocket Test</span>
            </a>
            <a href="{{ url_for('settings') }}" class="nav-item active">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span>Settings</span>
            </a>
        </div>
    </div>

    <div class="settings-container">
        <h1>‚öôÔ∏è System Settings</h1>
        
        <!-- Service Configuration -->
        <div class="settings-section">
            <div class="settings-title">
                <span>üîß</span>
                <span>Service Configuration</span>
            </div>
            
            <div class="settings-grid">
                <div class="setting-item">
                    <div class="setting-label">Whisper Service URL</div>
                    <div class="setting-description">URL for the Whisper speech-to-text service</div>
                    <input type="url" class="setting-input" id="whisperUrl" value="http://localhost:5001" placeholder="http://localhost:5001">
                    <div class="service-status unknown" id="whisperStatus">
                        <div class="status-dot"></div>
                        <span>Checking...</span>
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">Translation Service URL</div>
                    <div class="setting-description">URL for the translation service</div>
                    <input type="url" class="setting-input" id="translationUrl" value="http://localhost:5003" placeholder="http://localhost:5003">
                    <div class="service-status unknown" id="translationStatus">
                        <div class="status-dot"></div>
                        <span>Checking...</span>
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">Speaker Service URL</div>
                    <div class="setting-description">URL for the speaker diarization service</div>
                    <input type="url" class="setting-input" id="speakerUrl" value="http://localhost:5002" placeholder="http://localhost:5002">
                    <div class="service-status unknown" id="speakerStatus">
                        <div class="status-dot"></div>
                        <span>Checking...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Audio Settings -->
        <div class="settings-section">
            <div class="settings-title">
                <span>üé§</span>
                <span>Audio Settings</span>
            </div>
            
            <div class="settings-grid">
                <div class="setting-item">
                    <div class="setting-label">Default Audio Device</div>
                    <div class="setting-description">Select the default microphone for recording</div>
                    <select class="setting-select" id="audioDevice">
                        <option value="">System Default</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">Sample Rate</div>
                    <div class="setting-description">Audio sample rate for recording</div>
                    <select class="setting-select" id="sampleRate">
                        <option value="16000">16 kHz (Recommended)</option>
                        <option value="22050">22 kHz</option>
                        <option value="44100">44 kHz</option>
                        <option value="48000">48 kHz</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">Audio Format</div>
                    <div class="setting-description">Recording format preference</div>
                    <select class="setting-select" id="audioFormat">
                        <option value="auto">Auto-detect Best</option>
                        <option value="audio/webm;codecs=opus">WebM/Opus</option>
                        <option value="audio/mp4">MP4</option>
                        <option value="audio/ogg">OGG</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Processing Settings -->
        <div class="settings-section">
            <div class="settings-title">
                <span>‚ö°</span>
                <span>Processing Settings</span>
            </div>
            
            <div class="settings-grid">
                <div class="setting-item">
                    <div class="setting-label">Enable Audio Processing</div>
                    <div class="setting-description">Enable advanced audio processing pipeline</div>
                    <div class="setting-checkbox">
                        <input type="checkbox" id="enableProcessing" checked>
                        <label for="enableProcessing">Enable enhanced audio processing</label>
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">Voice Activity Detection</div>
                    <div class="setting-description">Enable voice activity detection for better processing</div>
                    <div class="setting-checkbox">
                        <input type="checkbox" id="enableVAD" checked>
                        <label for="enableVAD">Enable VAD</label>
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">Noise Reduction</div>
                    <div class="setting-description">Enable noise reduction for cleaner audio</div>
                    <div class="setting-checkbox">
                        <input type="checkbox" id="enableNoiseReduction" checked>
                        <label for="enableNoiseReduction">Enable noise reduction</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- WebSocket Settings -->
        <div class="settings-section">
            <div class="settings-title">
                <span>üîå</span>
                <span>WebSocket Settings</span>
            </div>
            
            <div class="settings-grid">
                <div class="setting-item">
                    <div class="setting-label">Connection Timeout</div>
                    <div class="setting-description">WebSocket connection timeout in seconds</div>
                    <input type="number" class="setting-input" id="wsTimeout" value="30" min="10" max="300">
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">Reconnection Attempts</div>
                    <div class="setting-description">Number of automatic reconnection attempts</div>
                    <input type="number" class="setting-input" id="wsReconnectAttempts" value="5" min="1" max="20">
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">Heartbeat Interval</div>
                    <div class="setting-description">Heartbeat interval in seconds</div>
                    <input type="number" class="setting-input" id="wsHeartbeat" value="30" min="10" max="120">
                </div>
            </div>
        </div>

        <!-- UI Settings -->
        <div class="settings-section">
            <div class="settings-title">
                <span>üé®</span>
                <span>Interface Settings</span>
            </div>
            
            <div class="settings-grid">
                <div class="setting-item">
                    <div class="setting-label">Theme</div>
                    <div class="setting-description">Choose your preferred color theme</div>
                    <select class="setting-select" id="theme">
                        <option value="dark">Dark Theme</option>
                        <option value="light">Light Theme</option>
                        <option value="auto">Auto (System)</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">Language</div>
                    <div class="setting-description">Interface language</div>
                    <select class="setting-select" id="language">
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">Show Advanced Options</div>
                    <div class="setting-description">Display advanced configuration options</div>
                    <div class="setting-checkbox">
                        <input type="checkbox" id="showAdvanced">
                        <label for="showAdvanced">Show advanced options</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Actions -->
        <div class="settings-actions">
            <button class="button" id="resetBtn">Reset to Defaults</button>
            <button class="button" id="exportBtn">Export Settings</button>
            <button class="button" id="importBtn">Import Settings</button>
            <button class="button primary" id="saveBtn">Save Settings</button>
        </div>
    </div>

    <script>
        // Settings management
        const settings = {
            whisperUrl: 'http://localhost:5001',
            translationUrl: 'http://localhost:5003',
            speakerUrl: 'http://localhost:5002',
            audioDevice: '',
            sampleRate: '16000',
            audioFormat: 'auto',
            enableProcessing: true,
            enableVAD: true,
            enableNoiseReduction: true,
            wsTimeout: 30,
            wsReconnectAttempts: 5,
            wsHeartbeat: 30,
            theme: 'dark',
            language: 'en',
            showAdvanced: false
        };

        // Load settings from localStorage
        function loadSettings() {
            const saved = localStorage.getItem('livetranslate-settings');
            if (saved) {
                Object.assign(settings, JSON.parse(saved));
            }
            updateUI();
        }

        // Save settings to localStorage
        function saveSettings() {
            localStorage.setItem('livetranslate-settings', JSON.stringify(settings));
            showNotification('Settings saved successfully!', 'success');
        }

        // Update UI with current settings
        function updateUI() {
            Object.entries(settings).forEach(([key, value]) => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = value;
                    } else {
                        element.value = value;
                    }
                }
            });
        }

        // Collect settings from UI
        function collectSettings() {
            Object.keys(settings).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        settings[key] = element.checked;
                    } else if (element.type === 'number') {
                        settings[key] = parseInt(element.value);
                    } else {
                        settings[key] = element.value;
                    }
                }
            });
        }

        // Check service health
        async function checkServiceHealth() {
            const services = [
                { id: 'whisperStatus', url: settings.whisperUrl + '/health' },
                { id: 'translationStatus', url: settings.translationUrl + '/api/health' },
                { id: 'speakerStatus', url: settings.speakerUrl + '/health' }
            ];

            for (const service of services) {
                const statusEl = document.getElementById(service.id);
                try {
                    const response = await fetch(service.url);
                    if (response.ok) {
                        statusEl.className = 'service-status healthy';
                        statusEl.querySelector('span').textContent = 'Healthy';
                    } else {
                        statusEl.className = 'service-status unhealthy';
                        statusEl.querySelector('span').textContent = 'Unhealthy';
                    }
                } catch (error) {
                    statusEl.className = 'service-status unhealthy';
                    statusEl.querySelector('span').textContent = 'Offline';
                }
            }
        }

        // Load available audio devices
        async function loadAudioDevices() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioDevices = devices.filter(device => device.kind === 'audioinput');
                const select = document.getElementById('audioDevice');
                
                // Clear existing options (keep default)
                select.innerHTML = '<option value="">System Default</option>';
                
                audioDevices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.textContent = device.label || `Microphone ${device.deviceId.substr(0, 8)}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load audio devices:', error);
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                background: ${type === 'success' ? '#2ed573' : type === 'error' ? '#ff4757' : '#007bff'};
                animation: slideIn 0.3s ease-out;
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Event listeners
        document.getElementById('saveBtn').addEventListener('click', () => {
            collectSettings();
            saveSettings();
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            if (confirm('Reset all settings to defaults?')) {
                localStorage.removeItem('livetranslate-settings');
                location.reload();
            }
        });

        document.getElementById('exportBtn').addEventListener('click', () => {
            collectSettings();
            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'livetranslate-settings.json';
            a.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById('importBtn').addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const imported = JSON.parse(e.target.result);
                            Object.assign(settings, imported);
                            updateUI();
                            showNotification('Settings imported successfully!', 'success');
                        } catch (error) {
                            showNotification('Failed to import settings', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadAudioDevices();
            checkServiceHealth();
            
            // Check service health every 30 seconds
            setInterval(checkServiceHealth, 30000);
        });
    </script>
    <script src="{{ url_for('static', filename='js/navigation.js') }}"></script>
</body>
</html>